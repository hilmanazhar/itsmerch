<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="assets/images/logo.png">
    <link rel="apple-touch-icon" href="assets/images/logo.png">
    <title>Admin Dashboard - myITS Merchandise</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body>
    <!-- Mobile Header -->
    <header class="mobile-header">
        <button class="hamburger-btn" onclick="toggleSidebar()">
            <i class="bi bi-list"></i>
        </button>
        <div class="logo-mini">my<span>ITS</span> Admin</div>
        <button onclick="logout()" class="btn btn-sm btn-outline-danger">
            <i class="bi bi-box-arrow-right"></i>
        </button>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="toggleSidebar()"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 sidebar d-flex flex-column">
                <div class="logo" style="display: flex; align-items: center; gap: 10px;">
                    <img src="assets/images/logo.png" alt="Logo" style="width: 40px; height: 40px;">
                    <h2 style="margin: 0; font-size: 1.2rem;">my<span style="color:#9b59b6">ITS</span><br>Admin</h2>
                </div>
                <ul class="nav flex-column mb-auto nav-pills">
                    <li class="nav-item">
                        <a class="nav-link" href="/home"><i class="bi bi-house-door"></i> Toko</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/catalog"><i class="bi bi-box"></i> Katalog Produk</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="bi bi-graph-up"></i> Sales Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/orders"><i class="bi bi-clipboard-check"></i> Kelola Pesanan</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/coupons-admin"><i class="bi bi-ticket-perforated"></i> Kelola
                            Kupon</a>
                    </li>
                </ul>
                <div class="mt-auto p-3">
                    <button onclick="logout()" class="btn btn-outline-danger w-100">Logout</button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 px-3 px-md-4">
                <div
                    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 pt-4">
                    <h2 class="fw-bold text-white mb-3 mb-md-0">Sales Dashboard</h2>
                    <button onclick="logout()" class="btn btn-outline-danger btn-sm d-none d-md-block">Logout</button>
                </div>

                <!-- Stats Cards -->
                <div class="row g-3 g-md-4 mb-4">
                    <div class="col-6 col-md-6">
                        <div class="card bg-dark border-secondary text-white h-100">
                            <div class="card-body p-3 p-md-4">
                                <h6 class="card-title text-muted mb-2"><i class="bi bi-cash-stack me-2"></i>Total
                                    Pendapatan</h6>
                                <h3 class="fw-bold text-success mb-0" id="totalRevenue">Rp 0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-6">
                        <div class="card bg-dark border-secondary text-white h-100">
                            <div class="card-body p-3 p-md-4">
                                <h6 class="card-title text-muted mb-2"><i class="bi bi-cart-check me-2"></i>Total
                                    Pesanan</h6>
                                <h3 class="fw-bold text-info mb-0" id="totalOrders">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 g-md-4">
                    <!-- Recent Orders -->
                    <div class="col-12 col-lg-8">
                        <div class="card bg-dark border-secondary text-white">
                            <div class="card-header border-secondary fw-bold">
                                <i class="bi bi-clock-history me-2"></i>Pesanan Terbaru
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-dark table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>User</th>
                                                <th>Total</th>
                                                <th>Status</th>
                                                <th class="d-none d-md-table-cell">Waktu</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentOrdersTable">
                                            <tr>
                                                <td colspan="5" class="text-center">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Products -->
                    <div class="col-12 col-lg-4">
                        <div class="card bg-dark border-secondary text-white">
                            <div class="card-header border-secondary fw-bold">
                                <i class="bi bi-trophy me-2"></i>Produk Terlaris
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush" id="topProductsList">
                                    <li class="list-group-item bg-transparent text-white">Loading...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = getUser();
            if (!user || user.role !== 'admin') {
                alert('Akses ditolak');
                window.location.href = '/home';
                return;
            }
            loadDashboard();
        });

        function loadDashboard() {
            fetchJson(`${apiBase}/get_sales_stats.php`)
                .then(data => {
                    document.getElementById('totalRevenue').innerText = 'Rp ' + Number(data.revenue).toLocaleString();
                    document.getElementById('totalOrders').innerText = data.total_orders;

                    // Recent Orders
                    const tbody = document.getElementById('recentOrdersTable');
                    if (data.recent_orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada pesanan</td></tr>';
                    } else {
                        tbody.innerHTML = data.recent_orders.map(o => `
                            <tr>
                                <td>#${o.id}</td>
                                <td>${escapeHtml(o.name)}</td>
                                <td>Rp ${Number(o.total_amount).toLocaleString()}</td>
                                <td><span class="badge bg-${o.status === 'completed' ? 'success' : 'warning'}">${o.status}</span></td>
                                <td class="d-none d-md-table-cell"><small>${o.created_at}</small></td>
                            </tr>
                        `).join('');
                    }

                    // Top Products
                    const list = document.getElementById('topProductsList');
                    if (data.top_products.length === 0) {
                        list.innerHTML = '<li class="list-group-item bg-transparent text-muted">Belum ada data</li>';
                    } else {
                        list.innerHTML = data.top_products.map((p, i) => `
                            <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                                <span>${i + 1}. ${escapeHtml(p.name)}</span>
                                <span class="badge bg-primary rounded-pill">${p.sold} terjual</span>
                            </li>
                        `).join('');
                    }
                });
        }
    </script>
</body>

</html>