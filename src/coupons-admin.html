<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Kelola Kupon - myITS Merchandise Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .coupon-card {
            transition: all 0.2s;
        }

        .coupon-card:hover {
            border-color: var(--its-blue) !important;
        }

        .coupon-code {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .coupon-inactive {
            opacity: 0.6;
        }
    </style>
</head>

<body>
    <!-- Mobile Header -->
    <header class="mobile-header">
        <button class="hamburger-btn" onclick="toggleSidebar()">
            <i class="bi bi-list"></i>
        </button>
        <div class="logo-mini">Kelola Kupon</div>
        <button onclick="logout()" class="btn btn-sm btn-outline-danger">
            <i class="bi bi-box-arrow-right"></i>
        </button>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="toggleSidebar()"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 sidebar d-flex flex-column">
                <div class="logo" style="display: flex; align-items: center; gap: 10px;">
                    <img src="assets/images/logo.png" alt="Logo" style="width: 40px; height: 40px;">
                    <h2 style="margin: 0; font-size: 1.2rem;">my<span style="color:#9b59b6">ITS</span><br>Admin</h2>
                </div>
                <ul class="nav flex-column mb-auto nav-pills">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="bi bi-house-door"></i> Toko</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="catalog.html"><i class="bi bi-box"></i> Katalog Produk</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="admin.html"><i class="bi bi-graph-up"></i> Sales Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html"><i class="bi bi-clipboard-check"></i> Kelola Pesanan</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="coupons-admin.html"><i class="bi bi-ticket-perforated"></i>
                            Kelola Kupon</a>
                    </li>
                </ul>
                <div class="mt-auto p-3">
                    <button onclick="logout()" class="btn btn-outline-danger w-100">Logout</button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 px-3 px-md-4">
                <div
                    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 pt-4">
                    <div>
                        <h2 class="fw-bold text-white mb-1"><i class="bi bi-ticket-perforated me-2"></i>Kelola Kupon
                        </h2>
                        <p class="text-muted mb-0">Buat dan kelola kupon diskon</p>
                    </div>
                    <button class="btn btn-primary mt-3 mt-md-0" data-bs-toggle="modal"
                        data-bs-target="#addCouponModal">
                        <i class="bi bi-plus-circle me-2"></i>Tambah Kupon
                    </button>
                </div>

                <!-- Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="card bg-dark border-secondary text-white">
                            <div class="card-body text-center">
                                <h4 class="fw-bold text-info mb-0" id="statTotal">0</h4>
                                <small class="text-muted">Total Kupon</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card bg-dark border-secondary text-white">
                            <div class="card-body text-center">
                                <h4 class="fw-bold text-success mb-0" id="statActive">0</h4>
                                <small class="text-muted">Aktif</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card bg-dark border-secondary text-white">
                            <div class="card-body text-center">
                                <h4 class="fw-bold text-warning mb-0" id="statUsed">0</h4>
                                <small class="text-muted">Digunakan</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card bg-dark border-secondary text-white">
                            <div class="card-body text-center">
                                <h4 class="fw-bold text-danger mb-0" id="statExpired">0</h4>
                                <small class="text-muted">Kadaluarsa</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coupon List -->
                <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-white"><i class="bi bi-list-ul me-2"></i>Daftar Kupon</span>
                    </div>
                    <div class="card-body">
                        <div id="couponList" class="row g-3">
                            <div class="col-12 text-center py-4">
                                <div class="spinner-border text-primary"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Coupon Modal -->
    <div class="modal fade" id="addCouponModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <form class="modal-content" id="addCouponForm">
                <input type="hidden" name="id" id="couponId">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="couponModalTitle"><i class="bi bi-plus-circle me-2"></i>Tambah
                        Kupon Baru</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Kode Kupon <span class="text-danger">*</span></label>
                            <input type="text" class="form-control text-uppercase" name="code" required
                                placeholder="CONTOH: DISKON20" style="letter-spacing: 2px;">
                            <small class="text-muted">Gunakan huruf kapital tanpa spasi</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipe Diskon <span class="text-danger">*</span></label>
                            <select class="form-select" name="type" required>
                                <option value="percentage">Persentase (%)</option>
                                <option value="fixed">Nominal Tetap (Rp)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nilai Diskon <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="value" required min="1"
                                    placeholder="10">
                                <span class="input-group-text" id="valueUnit">%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Min. Pembelian</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input type="number" class="form-control" name="min_purchase" placeholder="50000"
                                    value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Max Diskon</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input type="number" class="form-control" name="max_discount" placeholder="Opsional">
                            </div>
                            <small class="text-muted">Hanya untuk tipe persentase</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Batas Penggunaan</label>
                            <input type="number" class="form-control" name="usage_limit" placeholder="Tidak terbatas">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Berlaku Dari</label>
                            <input type="datetime-local" class="form-control" name="valid_from">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Berlaku Sampai</label>
                            <input type="datetime-local" class="form-control" name="valid_until">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" name="description" rows="2"
                                placeholder="Deskripsi kupon..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Simpan Kupon
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        let allCoupons = [];
        let couponModal;

        document.addEventListener('DOMContentLoaded', () => {
            const user = getUser();
            if (!user || user.role !== 'admin') {
                alert('Akses ditolak');
                window.location.href = 'index.html';
                return;
            }
            loadCoupons();
            setupForm();

            // Initialize modal
            const modalEl = document.getElementById('addCouponModal');
            couponModal = new bootstrap.Modal(modalEl);

            // Reset form when modal calls show for adding
            modalEl.addEventListener('hidden.bs.modal', () => {
                document.getElementById('addCouponForm').reset();
                document.getElementById('couponId').value = '';
                document.getElementById('couponModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Tambah Kupon Baru';
                document.getElementById('valueUnit').textContent = '%';
            });
        });

        function loadCoupons() {
            fetchJson(`${apiBase}/coupons.php?admin=true`)
                .then(res => {
                    if (!res.success) {
                        throw new Error(res.error);
                    }
                    allCoupons = res.coupons;
                    renderCoupons(allCoupons);
                    updateStats(allCoupons);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('couponList').innerHTML = `
                        <div class="col-12 text-center text-danger py-4">
                            <i class="bi bi-exclamation-circle fs-1"></i>
                            <p class="mt-2">Gagal memuat kupon</p>
                        </div>`;
                });
        }

        function updateStats(coupons) {
            const now = new Date();
            document.getElementById('statTotal').textContent = coupons.length;
            document.getElementById('statActive').textContent = coupons.filter(c => c.is_active == 1).length;
            document.getElementById('statUsed').textContent = coupons.reduce((sum, c) => sum + (c.used_count || 0), 0);
            document.getElementById('statExpired').textContent = coupons.filter(c =>
                c.valid_until && new Date(c.valid_until) < now
            ).length;
        }

        function renderCoupons(coupons) {
            const container = document.getElementById('couponList');

            if (coupons.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted py-5">
                        <i class="bi bi-ticket-perforated fs-1 mb-3 d-block"></i>
                        <h5>Belum ada kupon</h5>
                        <p>Klik tombol "Tambah Kupon" untuk membuat kupon baru</p>
                    </div>`;
                return;
            }

            const now = new Date();
            container.innerHTML = coupons.map(coupon => {
                const isExpired = coupon.valid_until && new Date(coupon.valid_until) < now;
                const isActive = coupon.is_active == 1 && !isExpired;

                return `
                <div class="col-md-6 col-lg-4">
                    <div class="card bg-dark border-secondary coupon-card ${!isActive ? 'coupon-inactive' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="coupon-code text-primary">${escapeHtml(coupon.code)}</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           ${coupon.is_active == 1 ? 'checked' : ''} 
                                           onchange="toggleCoupon(${coupon.id}, this.checked)"
                                           ${isExpired ? 'disabled' : ''}>
                                </div>
                            </div>
                            
                            <p class="text-muted small mb-2">${escapeHtml(coupon.description || 'Tidak ada deskripsi')}</p>
                            
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <span class="badge bg-${coupon.type === 'percentage' ? 'info' : 'success'}">
                                    ${coupon.type === 'percentage' ? coupon.value + '%' : 'Rp ' + Number(coupon.value).toLocaleString()}
                                </span>
                                ${coupon.min_purchase > 0 ? `<span class="badge bg-secondary">Min Rp ${Number(coupon.min_purchase).toLocaleString()}</span>` : ''}
                                ${isExpired ? '<span class="badge bg-danger">Kadaluarsa</span>' : ''}
                            </div>
                            
                            <div class="row text-center small text-muted mb-3">
                                <div class="col-6 border-end border-secondary">
                                    <div class="fw-bold text-white">${coupon.used_count || 0}${coupon.usage_limit ? '/' + coupon.usage_limit : ''}</div>
                                    <div>Digunakan</div>
                                </div>
                                <div class="col-6">
                                    <div class="fw-bold text-white">${coupon.valid_until ? formatDate(coupon.valid_until) : 'âˆž'}</div>
                                    <div>Berlaku Sampai</div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-warning btn-sm w-50" onclick="editCoupon(${coupon.id})">
                                    <i class="bi bi-pencil me-1"></i>Edit
                                </button>
                                <button class="btn btn-outline-danger btn-sm w-50" onclick="deleteCoupon(${coupon.id}, '${escapeHtml(coupon.code)}')">
                                    <i class="bi bi-trash me-1"></i>Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function editCoupon(id) {
            const coupon = allCoupons.find(c => c.id == id);
            if (!coupon) return;

            const form = document.getElementById('addCouponForm');

            // Set fields directly
            document.getElementById('couponId').value = coupon.id;
            form.querySelector('[name="code"]').value = coupon.code;
            form.querySelector('[name="type"]').value = coupon.type;
            form.querySelector('[name="value"]').value = coupon.value;
            form.querySelector('[name="min_purchase"]').value = coupon.min_purchase;
            form.querySelector('[name="max_discount"]').value = coupon.max_discount || '';
            form.querySelector('[name="usage_limit"]').value = coupon.usage_limit || '';
            form.querySelector('[name="valid_from"]').value = coupon.valid_from ? coupon.valid_from.replace(' ', 'T') : '';
            form.querySelector('[name="valid_until"]').value = coupon.valid_until ? coupon.valid_until.replace(' ', 'T') : '';
            form.querySelector('[name="description"]').value = coupon.description || '';

            // UI adjustments
            document.getElementById('couponModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Kupon';
            document.getElementById('valueUnit').textContent = coupon.type === 'percentage' ? '%' : 'Rp';

            couponModal.show();
        }

        function setupForm() {
            const form = document.getElementById('addCouponForm');
            const typeSelect = form.querySelector('[name="type"]');
            const valueUnit = document.getElementById('valueUnit');

            // Update unit when type changes
            typeSelect.addEventListener('change', () => {
                valueUnit.textContent = typeSelect.value === 'percentage' ? '%' : 'Rp';
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                data.action = 'create';

                // If ID exists, it's an update (PUT)
                const id = data.id;
                const method = id ? 'PUT' : 'POST';

                // Clean up empty values
                if (!data.max_discount) delete data.max_discount;
                if (!data.usage_limit) delete data.usage_limit;
                if (!data.valid_from) delete data.valid_from;
                if (!data.valid_until) delete data.valid_until;

                fetchJson(`${apiBase}/coupons.php`, {
                    method: method,
                    body: data
                }).then(res => {
                    if (res.success) {
                        couponModal.hide();
                        form.reset();
                        showToast(id ? 'Kupon berhasil diupdate!' : 'Kupon berhasil ditambahkan!');
                        loadCoupons();
                    } else {
                        alert('Gagal: ' + (res.error || 'Unknown error'));
                    }
                }).catch(err => {
                    console.error(err);
                    alert('Terjadi kesalahan');
                });
            });
        }

        function toggleCoupon(id, isActive) {
            fetchJson(`${apiBase}/coupons.php`, {
                method: 'PUT',
                body: { id: id, is_active: isActive }
            }).then(res => {
                if (res.success) {
                    showToast(isActive ? 'Kupon diaktifkan' : 'Kupon dinonaktifkan');
                    loadCoupons();
                } else {
                    alert('Gagal mengubah status kupon');
                    loadCoupons(); // Reload to reset state
                }
            });
        }

        function deleteCoupon(id, code) {
            if (!confirm(`Hapus kupon "${code}"?`)) return;

            fetchJson(`${apiBase}/coupons.php?id=${id}`, {
                method: 'DELETE'
            }).then(res => {
                if (res.success) {
                    showToast('Kupon berhasil dihapus');
                    loadCoupons();
                } else {
                    alert('Gagal menghapus kupon');
                }
            });
        }
    </script>
</body>

</html>